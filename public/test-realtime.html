<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时通信测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .reconnecting { background-color: #fff3cd; color: #856404; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>🔗 实时通信测试</h1>
    
    <div id="status" class="status disconnected">
        状态: 未连接
    </div>
    
    <div>
        <button id="connectBtn" class="btn-primary">连接</button>
        <button id="disconnectBtn" class="btn-secondary">断开</button>
        <button id="testSSEBtn" class="btn-primary">测试SSE</button>
        <button id="testPollBtn" class="btn-primary">测试长轮询</button>
        <button id="clearLogBtn" class="btn-danger">清除日志</button>
    </div>
    
    <h3>📋 连接日志</h3>
    <div id="log" class="log"></div>
    
    <h3>🧪 测试信息</h3>
    <ul>
        <li><strong>设备ID:</strong> <span id="deviceId">-</span></li>
        <li><strong>连接类型:</strong> <span id="connectionType">-</span></li>
        <li><strong>重连次数:</strong> <span id="reconnectCount">0</span></li>
        <li><strong>消息计数:</strong> <span id="messageCount">0</span></li>
    </ul>

    <script>
        // 简化的工具函数
        const Utils = {
            getDeviceId() {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = 'web-' + Date.now() + '-' + Math.random().toString(36).substring(2);
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            }
        };

        // 简化的UI函数
        const UI = {
            setConnectionStatus(status) {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${status}`;
                statusEl.textContent = `状态: ${status}`;
            }
        };

        // 日志函数
        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // 更新测试信息
        function updateTestInfo() {
            document.getElementById('deviceId').textContent = Utils.getDeviceId();
            document.getElementById('connectionType').textContent = window.testRealtime ? 
                (window.testRealtime.eventSource ? 'SSE' : 
                 window.testRealtime.longPollingActive ? '长轮询' : '无') : '无';
            document.getElementById('reconnectCount').textContent = window.testRealtime ? 
                window.testRealtime.reconnectAttempts : 0;
        }

        // 简化的实时通信管理器（仅用于测试）
        class TestRealtimeManager {
            constructor() {
                this.eventSource = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 3;
                this.deviceId = Utils.getDeviceId();
                this.longPollingActive = false;
                this.messageCount = 0;
            }

            // 测试SSE连接
            testSSE() {
                log('🔗 测试SSE连接...');
                
                try {
                    const url = `/api/events?deviceId=${encodeURIComponent(this.deviceId)}`;
                    this.eventSource = new EventSource(url);

                    this.eventSource.addEventListener('connection', (event) => {
                        log('✅ SSE连接成功');
                        this.isConnected = true;
                        UI.setConnectionStatus('connected');
                        updateTestInfo();
                    });

                    this.eventSource.addEventListener('message', (event) => {
                        this.messageCount++;
                        log(`📨 收到SSE消息: ${event.data}`);
                        document.getElementById('messageCount').textContent = this.messageCount;
                    });

                    this.eventSource.addEventListener('heartbeat', (event) => {
                        log('💓 收到心跳');
                    });

                    this.eventSource.onerror = (event) => {
                        log('❌ SSE连接错误');
                        this.isConnected = false;
                        UI.setConnectionStatus('disconnected');
                        updateTestInfo();
                    };

                } catch (error) {
                    log(`❌ SSE连接失败: ${error.message}`);
                }
            }

            // 测试长轮询
            async testLongPolling() {
                log('🔗 测试长轮询...');
                this.longPollingActive = true;
                this.longPoll();
                updateTestInfo();
            }

            async longPoll() {
                if (!this.longPollingActive) return;

                try {
                    const url = `/api/poll?deviceId=${encodeURIComponent(this.deviceId)}&lastMessageId=0&timeout=10`;
                    log(`🔄 发起长轮询请求: ${url}`);
                    
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success) {
                        this.messageCount++;
                        log(`✅ 长轮询响应: ${JSON.stringify(data)}`);
                        document.getElementById('messageCount').textContent = this.messageCount;
                        
                        if (!this.isConnected) {
                            this.isConnected = true;
                            UI.setConnectionStatus('connected');
                        }
                    } else {
                        log(`❌ 长轮询失败: ${data.error}`);
                    }

                } catch (error) {
                    log(`❌ 长轮询请求失败: ${error.message}`);
                    this.isConnected = false;
                    UI.setConnectionStatus('disconnected');
                }

                // 继续下一次轮询
                if (this.longPollingActive) {
                    setTimeout(() => this.longPoll(), 2000);
                }
            }

            disconnect() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                this.longPollingActive = false;
                this.isConnected = false;
                UI.setConnectionStatus('disconnected');
                log('🔌 连接已断开');
                updateTestInfo();
            }
        }

        // 创建测试实例
        window.testRealtime = new TestRealtimeManager();

        // 绑定按钮事件
        document.getElementById('connectBtn').addEventListener('click', () => {
            window.testRealtime.testSSE();
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            window.testRealtime.disconnect();
        });

        document.getElementById('testSSEBtn').addEventListener('click', () => {
            window.testRealtime.testSSE();
        });

        document.getElementById('testPollBtn').addEventListener('click', () => {
            window.testRealtime.testLongPolling();
        });

        document.getElementById('clearLogBtn').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // 初始化
        updateTestInfo();
        log('🚀 测试页面已加载');
    </script>
</body>
</html>
